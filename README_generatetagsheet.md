# generatetagsheet
Tools to generate sheets of tags for insect tracking

## Requirements

- Unix system with BASH (Linux, MacOSX...)
- Python3, with packages:
    `mako, os, sys, getopt, datetime, math, re, collections`
- Tag sets (e.g. generated by april.tag.TagFamilyGenerator) 
- ImageMagick `convert` (to prepare tag image sets: crop, resize, change fileformat)
- `potrace` (to convert PNG/PBM to SVG)
- inkscape (to convert SVG tagsheet to PDF)


## HOWTO create tag sheets

0. Add utils directory to PATH:

```
    export PATH=/Users/megret/Documents/Research/BeeTracking/Soft/createtagsheet/bash:$PATH
```
or using script
```
    source bash/createtagsheet_startup.sh
```

1. Create directory of tag images

```
    tags/tag36h10inv/pbm/keyed????.pbm
```
  or
```
    tags/tag36h10inv/png/keyed????.png
```

  where ???? represents the tag id

  - If the tags contain the external inverted border, crop it using `dir_crop_png.sh`
    ```
        dir_crop_png.sh  pngraw/ png/ 1
    ```
  - If the files have custom prefix (such as the ones produced by apriltag Java tool), or have the wrong number of numbers in the ID, rename them using `dir_prefix_rename`
  ```
        dir_prefix_rename tags/tag36h10/png tag36_10_0 keyed
  ```
     Note: works also for other types of files
     
     
2. Convert tag images into SVG

```
    cd tags/tag36h10inv
    dir_pbm2svg.sh pbm svg
```
  or
```
    dir_png2svg.sh png svg
```


3. Create main SVG sheet

```
  cd tags
```
  make sure SVG files are available as `svg/keyed????.svg`

  e.g.:
```
  python ../python/generatetagsheet.py -f tag25h6 --dpp 10 -bx=5 -by=2 -v 958 --output tagsheet_25h6_10dpp.svg
```
  this creates the sheet as SVG using mako template engine
  then convert it to PDF using svg2pdf_inkscape.sh
  
  for help:
```
  python ../python/generatetagsheet.py -h
```

  To create a test page:
```
    python ../python/generatetagsheet.py --custom custom_tag36h10 --output tagsheet_custom_36h10.svg
    python ../python/generatetagsheet.py --custom custom_tag25h5 --output tagsheet_custom_25h5.svg
    python ../python/generatetagsheet.py --custom custom_tag25h6 --output tagsheet_custom_25h6.svg
```
  

      Tag structure and parameters:
        +-----------------+
        |    2            |
        |    I   id       |   [I = idtext is idheight_pix high]
        |   X2XXXXXXXXX   |   
        |   X.........X   |   
        |   X.       .X   |   
        |   X.       .X   |                          values for 36h10
        |2222.       .2222|    
        |   X.       .X   |   tagsize_pix=tagcode_pix+2*tagborder_pix = 8                      
        |   X.       .X   |   [  = code img,         tagcode_pix=6]
        |   X.........X   |   [. = tag inner border, tagborder_pix=1]
        |   X2XXXXXXXXX   |   [X = border1,          border1_pix=1]
        |    2            |   [2 = border2,          border2_pix=3]
        +-----------------+

## MISC

- Test sheets obtained using the custom setup. Sill print both positive and inverse tags, in different sizes:
```
	python ../python/generatetagsheet.py --custom custom_tag36h10 --output tagsheet_test36h10.svg
	python ../python/generatetagsheet.py --custom custom_tag25h5 --output tagsheet_test25h5.svg
	python ../python/generatetagsheet.py --custom custom_tag25h6 --output tagsheet_test25h6.svg
```

- Memo relationship between printing dots and pixels
      at 2400dpi:
      2mm = 0.0787402in = 188dots
      for 9x9 tag, 1 tag pixel = 21 dots  

      at 72pt/pixel, 21dots=3.4pt

- Create tag25h5inv sheet for 13x19 paper:
for kerf_mm in 0.2 0.4 0.6 0.8 1.0; do echo kerf=$kerf_mm; python ../python/generatetagsheet.py -f tag25h5inv -p 5 -u 0 -v 3008 -bx 5 -by 7 -d 10 -s 2 -o tagsheet_25h5inv_10dpp_CUTS${kerf_mm}.svg -m 1 -pw 482.6 -ph 330.2 -bm 5.08 -tm 10 -kt -ktx 40 -kty 430 -kf ${kerf_mm}; done

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -u 0 -v 3008 -bx 5 -by 7 -d 10 -s 2 -o tagsheet_25h5inv_10dpp_color.svg -m=-2 -pw 482.6 -ph 330.2 -bm 5.08 -tm 10 -kt -ktx 40 -kty 430


- Create tag25h5inv sheet for 13x19 paper:
```
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -u 0 -v 3008 -bx 5 -by 7 -d 10 -s 2 -o tagsheet_25h5inv_10dpp_color.svg -m=-2 -pz 13x19 -bm 5.08 -tm 10 -kt -ktx 40 -kty 430
```

- Create tag25h5inv sheet for 8.5x11 paper: (May 6, 2017)
```
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 999 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -sc -m=tags -kf 0.2
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -sc -m=tags -kf 0.2
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -sc -m=all -kf 0.2

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 999 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -m=tags -kf 0.2
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -m=tags -kf 0.2
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -m=all -kf 0.2

# No opening
for kerf_mm in 0.2 0.4 0.6 0.8 1.0; do 
   echo kerf=$kerf_mm; 
   python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -sc -m=cuts -kf $kerf_mm -rm
done

# Opening x2
for kerf_mm in 0.2 0.4 0.6 0.8 1.0; do 
   echo kerf=$kerf_mm; 
   python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -bm 5.08 -tm 10 -kt -ktx 90 -kty 210 -sc -m=cuts -kf $kerf_mm -ko 2 -rm
done
```

Office Depot Plaza Las Americas, May 6:
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 3008 -bx 5 -by 7 -pz 12x18 -bm 5.08 -tm 10,13 -kt -ktx 180 -kty 410 -sc -m=all -kf 0.2


- Create tag25h5inv sheet for 19x13 paper: (May 6, 2017)
```
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 3008 -bx 5 -by 7 -pz 13x19 -bm 5.08 -tm 10,13 -kt -ktx 180 -kty 430 -sc -m=all -kf 0.2

for kerf_mm in 0.2 0.4 0.6 0.8 1.0; do 
   echo kerf=$kerf_mm; 
   python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 3008 -bx 5 -by 7 -pz 13x19 -bm 5.08 -tm 10,13 -kt -ktx 180 -kty 430 -sc -m=cuts -kf $kerf_mm
done
```

- Create tag25h5inv cut sheet for 8.5x11 paper: (May 9, 2017)

kerf_mm=1.2
opening 

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 210 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 90 -tpy 250 -m=tags -col0 '#c00000' -col1 '#008080' -sb

# redcode:
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 210 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 90 -tpy 250 -m=tags -col0 '#a00' -col1 '#088' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_redcode' -sbc

# bluecode:
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0 -v 999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 210 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 90 -tpy 250 -m=tags -col0 '#00a' -col1 '#880' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_bluecode' -sbc

# blackcode
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0000 -v 0999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#fff' -col1 '#000' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_blackcode' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#fff' -col1 '#000' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_blackcode' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags,cuts -col0 '#fff' -col1 '#000' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_blackcode' -sbc -rm

# bluecode
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0000 -v 0999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 90 -tpy 250 -m=tags -col0 '#ff4' -col1 '#00a' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_bluecode' -sbc

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 90 -tpy 250 -m=tags -col0 '#ff4' -col1 '#00a' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_bluecode' -sbc

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags,cuts -col0 '#ff4' -col1 '#00a' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_bluecode' -sbc


# cyancode
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0000 -v 0999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_cyancode' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_cyancode' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags,cuts -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_cyancode' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}_cyancode' -sbc -kfv 0.5 -rm

# nocode
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 0000 -v 0999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#000' -col1 '#fff' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 1000 -v 1999 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags -col0 '#000' -col1 '#fff' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.2 -ko 0.5 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=tags,cuts -col0 '#000' -col1 '#fff' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -rm

# Correction -0.15mm inside

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 0.9 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.0 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 0.8 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 0.95 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm

python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 1.05 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm

# Second correction
python ../python/generatetagsheet.py -f tag25h5inv -p 5 -d 10 -u 2000 -v 3008 -bx 3 -by 4 -pz letter -kt -ktx 90 -kty 220 -kf 0.7 -kfv 0.45 -ko 0.7 -cx 12.7 -cy 12.7 -px 17.7 -py 17.7 -bm 10 -tm 12,11 -tp -tpx 110 -tpy 250 -m=cuts,view -col0 '#aff' -col1 '#a00' -sb -ob '{family}_dpp{tagdpp1200}_{page_size}_{first_id}-{last_id}' -sbc -rm


## Troubleshooting

- Error
`mako.exceptions.CompileException: Unicode decode operation of encoding 'ascii' failed in file '../python/mako_templates/template_closing.svg' at line: 0 char: 0`

  Due to template not saved at UTF8 with BOM
  