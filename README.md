# generatetagsheet
Tools to generate sheets of tags for insect tracking

## Requirements

- Unix system with BASH (Linux, MacOSX...)
- Python3, with packages:
    `mako, os, sys, getopt, datetime, math, re, collections`
- Tag sets (e.g. generated by april.tag.TagFamilyGenerator) 
- ImageMagick `convert` (to prepare tag image sets: crop, resize, change fileformat)
- `potrace` (to convert PNG/PBM to SVG)
- inkscape (to convert SVG tagsheet to PDF)


## HOWTO create tag sheets

0. Add utils directory to PATH:

```
    export PATH=/Users/megret/Documents/Research/BeeTracking/Soft/createtagsheet/bash:$PATH
```
or using script
```
    source bash/createtagsheet_startup.sh
```

1. Create directory of tag images

```
    tags/tag36h10inv/pbm/keyed????.pbm
```
  or
```
    tags/tag36h10inv/png/keyed????.png
```

  where ???? represents the tag id

  - If the tags contain the external inverted border, crop it using `dir_crop_png.sh`
    ```
        dir_crop_png.sh  pngraw/ png/ 1
    ```
  - If the files have custom prefix (such as the ones produced by apriltag Java tool), or have the wrong number of numbers in the ID, rename them using `dir_prefix_rename`
  ```
        dir_prefix_rename tags/tag36h10/png tag36_10_0 keyed
  ```
     Note: works also for other types of files
     
     
2. Convert tag images into SVG

```
    cd tags/tag36h10inv
    dir_pbm2svg.sh pbm svg
```
  or
```
    dir_png2svg.sh png svg
```


3. Create main SVG sheet

```
  cd tags
```
  make sure SVG files are available as `svg/keyed????.svg`

  e.g.:
```
  python ../python/generatetagsheet.py --dpp 10 -o tag25h5_sheet.svg -bx=1 -by=1 -td tag25h5/svg
```
  this creates the sheet as SVG using mako template engine
  then convert it to PDF using svg2pdf_inkscape.sh
  
  for help:
```
  python ../python/generatetagsheet.py -h
```
  

      Tag structure and parameters:
        +-----------------+
        |    2            |
        |    I   id       |   [I = idtext is idheight_pix high]
        |   X2XXXXXXXXX   |   
        |   X.........X   |   
        |   X.       .X   |   
        |   X.       .X   |                          values for 36h10
        |2222.       .2222|    
        |   X.       .X   |   tagsize_pix=tagcode_pix+2*tagborder_pix = 8                      
        |   X.       .X   |   [  = code img,         tagcode_pix=6]
        |   X.........X   |   [. = tag inner border, tagborder_pix=1]
        |   X2XXXXXXXXX   |   [X = border1,          border1_pix=1]
        |    2            |   [2 = border2,          border2_pix=3]
        +-----------------+

## MISC

- Test sheets obtained using the custom setup. Sill print both positive and inverse tags, in different sizes:
```
	python ../python/generatetagsheet.py --custom custom_tag36h10 --output tagsheet_test36h10.svg
	python ../python/generatetagsheet.py --custom custom_tag25h5 --output tagsheet_test25h5.svg
	python ../python/generatetagsheet.py --custom custom_tag25h6 --output tagsheet_test25h6.svg
```

- Memo relationship between printing dots and pixels
      at 2400dpi:
      2mm = 0.0787402in = 188dots
      for 9x9 tag, 1 tag pixel = 21 dots  

      at 72pt/pixel, 21dots=3.4pt

## Troubleshooting

- Error
`mako.exceptions.CompileException: Unicode decode operation of encoding 'ascii' failed in file '../python/mako_templates/template_closing.svg' at line: 0 char: 0`

  Due to template not saved at UTF8 with BOM
  